# Development Setup

Detailed instructions for setting up your local development environment.

## Prerequisites

### Required Software

| Tool | Minimum Version | Recommended | Purpose |
|------|----------------|-------------|---------|
| Node.js | 18.0.0 | 20.x LTS | JavaScript runtime |
| pnpm | 8.0.0 | Latest | Package manager |
| Python | 3.11 | 3.12 | Sandbox runtime |
| Git | 2.30 | Latest | Version control |

### Optional Tools

- **uv**: Python dependency management (required) - https://docs.astral.sh/uv/
- **VS Code**: Recommended IDE
- **Convex CLI**: `npm install -g convex`

## Installation

### 1. Clone Repository

```bash
git clone https://github.com/dlg0/report-writer.git
cd report-writer
```

### 2. Install Node Dependencies

```bash
# Install pnpm if not already installed
npm install -g pnpm

# Install project dependencies
pnpm install
```

This installs:
- All workspace dependencies (web, shared-types)
- Dev dependencies (Vitest, Playwright, ESLint, Prettier)

### 3. Set Up Convex

#### Install Convex CLI

```bash
npm install -g convex
```

#### Initialize Convex Project

```bash
cd convex

# Login to Convex (creates account if needed)
npx convex login

# Initialize project
npx convex dev
```

**Follow the prompts:**
- Create new project or link existing
- Choose project name (e.g., `report-writer-dev`)
- Select deployment (dev, prod, etc.)

**Output:**
- `.env.local` file created with `CONVEX_URL`
- Dev deployment started

**Verify:**
```bash
# Should show your Convex deployment URL
cat .env.local
# CONVEX_URL=https://<your-deployment>.convex.cloud
```

### 4. Set Up Python Sandbox

#### Install Dependencies

```bash
cd apps/sandbox

# Using uv (required)
uv sync

# For development with dev dependencies
uv sync --dev
```

#### Configure Environment Variables

Create `apps/sandbox/.env`:

```bash
# LLM API Keys
OPENAI_API_KEY=sk-...
ANTHROPIC_API_KEY=sk-ant-...

# Choose default LLM provider
DEFAULT_LLM_PROVIDER=openai  # or anthropic

# Optional: Sandbox settings
SANDBOX_PORT=8000
LOG_LEVEL=info
```

**Get API Keys:**
- OpenAI: https://platform.openai.com/api-keys
- Anthropic: https://console.anthropic.com/settings/keys

### 5. Configure Web App

Create `apps/web/.env.local`:

```bash
# Convex connection (auto-generated by convex dev)
VITE_CONVEX_URL=https://<your-deployment>.convex.cloud

# Optional: Feature flags
VITE_ENABLE_AGENT_THREADS=true
VITE_ENABLE_VERSION_HISTORY=true
```

## Running Services

### Option A: Run All Services (Recommended)

From project root:

```bash
# Terminal 1: Convex backend
npx convex dev

# Terminal 2: Web app
pnpm --filter web dev

# Terminal 3: Python sandbox
cd apps/sandbox
source venv/bin/activate
uvicorn app.main:app --reload --port 8000
```

### Option B: Individual Services

#### Convex Backend

```bash
cd convex
npx convex dev
```

**Output:**
```
Convex dev server running
Dashboard: https://dashboard.convex.dev/deployment/<id>
Watching for file changes...
```

#### Web App

```bash
pnpm --filter web dev
```

**Output:**
```
VITE v4.5.0 ready in 500 ms

➜  Local:   http://localhost:5173/
➜  Network: use --host to expose
```

**Open browser:** http://localhost:5173

#### Python Sandbox

```bash
cd apps/sandbox
source venv/bin/activate  # If not already activated
uvicorn app.main:app --reload --port 8000
```

**Output:**
```
INFO:     Uvicorn running on http://127.0.0.1:8000
INFO:     Application startup complete.
```

**Test endpoint:**
```bash
curl http://localhost:8000/health
# Expected: {"status": "ok"}
```

## Verify Setup

### 1. Check Convex Connection

Open http://localhost:5173 and check browser console:

```
✅ Connected to Convex
```

### 2. Test Sandbox API

```bash
curl -X POST http://localhost:8000/v1/agent/run \
  -H "Content-Type: application/json" \
  -d '{
    "context": {"messages": [], "projectId": "test"},
    "userMessage": "Hello"
  }'
```

**Expected response:**
```json
{
  "message": "Hello! How can I help?",
  "proposedEdits": [],
  "toolCalls": []
}
```

### 3. Run Tests

```bash
npm run test:ci
```

**Expected:** All tests pass ✅

## Development Workflow

### Typical Development Session

```bash
# 1. Pull latest changes
git pull origin main

# 2. Install/update dependencies
pnpm install

# 3. Start services (3 terminals)
npx convex dev
pnpm --filter web dev
cd apps/sandbox && uvicorn app.main:app --reload

# 4. Make changes to code

# 5. Run tests
npm test

# 6. Commit changes
git add .
git commit -m "feat: add new feature"

# 7. Push
git push origin feature-branch
```

### Hot Reload

All services support hot reload:
- **Web app**: Vite auto-reloads on file change
- **Convex**: Watches `convex/` directory, redeploys on change
- **Sandbox**: `--reload` flag reloads on Python file change

### Debugging

#### Web App (Browser DevTools)

1. Open DevTools (F12)
2. Go to Sources tab
3. Set breakpoints in TypeScript files (source maps enabled)

#### Convex (Logs)

```bash
# View Convex logs
npx convex logs

# Or in dashboard
https://dashboard.convex.dev/deployment/<id>/logs
```

#### Python Sandbox (Debugger)

Add breakpoint:
```python
import pdb; pdb.set_trace()
```

Or use VS Code debugger with launch config:
```json
{
  "name": "Python: FastAPI",
  "type": "python",
  "request": "launch",
  "module": "uvicorn",
  "args": ["app.main:app", "--reload"],
  "cwd": "${workspaceFolder}/apps/sandbox"
}
```

## Environment Variables

### Convex

Auto-managed in `convex/.env.local`:
```bash
CONVEX_DEPLOYMENT=<deployment-id>
```

### Web App (`apps/web/.env.local`)

```bash
# Required
VITE_CONVEX_URL=https://<deployment>.convex.cloud

# Optional
VITE_APP_NAME=Report Writer
VITE_LOG_LEVEL=debug
```

### Sandbox (`apps/sandbox/.env`)

```bash
# Required
OPENAI_API_KEY=sk-...
ANTHROPIC_API_KEY=sk-ant-...

# Optional
DEFAULT_LLM_PROVIDER=openai
SANDBOX_PORT=8000
LOG_LEVEL=info
MAX_CONTEXT_TOKENS=8000
TEMPERATURE=0.7
```

## Troubleshooting

### "Module not found" errors

```bash
# Reinstall dependencies
pnpm install

# Clear cache
pnpm store prune
pnpm install
```

### Convex connection fails

1. Check `.env.local` has correct `CONVEX_URL`
2. Verify Convex dev is running: `npx convex dev`
3. Check network/firewall settings

### Python sandbox errors

```bash
# Reinstall dependencies
uv sync --reinstall

# Check Python version
uv run python --version  # Should be 3.11+
```

### Port already in use

```bash
# Find process using port
lsof -i :5173  # Web app
lsof -i :8000  # Sandbox

# Kill process
kill -9 <PID>

# Or use different port
uvicorn app.main:app --port 8001
```

### Tests failing

```bash
# Clear test cache
npm test -- --clearCache

# Run specific test
npm test -- <test-file-name>

# Verbose output
npm test -- --reporter=verbose
```

## IDE Setup

### VS Code (Recommended)

**Extensions:**
- ESLint
- Prettier
- Volar (Vue/TypeScript)
- Python
- Convex (official extension)

**Settings (`.vscode/settings.json`):**
```json
{
  "editor.formatOnSave": true,
  "editor.defaultFormatter": "esbenp.prettier-vscode",
  "[python]": {
    "editor.defaultFormatter": "ms-python.black-formatter"
  },
  "typescript.tsdk": "node_modules/typescript/lib"
}
```

### Recommended Plugins

- **Error Lens**: Inline error display
- **GitLens**: Git blame and history
- **TODO Highlight**: Highlight TODO comments

## Next Steps

After setup:

1. **Read the docs**: Start with [docs/architecture.md](architecture.md)
2. **Explore codebase**: Look at existing features in `apps/web/src/features/`
3. **Run tests**: `npm test` to see what's already tested
4. **Check issues**: `bd ready` to find tasks
5. **Make a change**: Try adding a small feature or fix

## Additional Resources

- **Convex Docs**: https://docs.convex.dev
- **Vite Docs**: https://vitejs.dev
- **FastAPI Docs**: https://fastapi.tiangolo.com
- **Vitest Docs**: https://vitest.dev
- **Playwright Docs**: https://playwright.dev

## Getting Help

- **Project docs**: `docs/` directory
- **Issues**: https://github.com/dlg0/report-writer/issues
- **Discussions**: GitHub Discussions
- **Convex Discord**: https://discord.gg/convex
